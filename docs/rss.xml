<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
      <title>Greg Hale&#x27;s Blog</title>
      <link>https://blog.greghale.io</link>
      <description>Personal blog of Greg Hale</description>
      <generator>Zola</generator>
      <language>en</language>
      <atom:link href="https://blog.greghale.io/rss.xml" rel="self" type="application/rss+xml"/>
      <lastBuildDate>Fri, 24 Oct 2025 00:00:00 +0000</lastBuildDate>
      <item>
          <title>Human and AI Consciousness</title>
          <pubDate>Fri, 24 Oct 2025 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://blog.greghale.io/posts/ai-consciousness/</link>
          <guid>https://blog.greghale.io/posts/ai-consciousness/</guid>
          <description xml:base="https://blog.greghale.io/posts/ai-consciousness/">&lt;p&gt;Are LLM&#x27;s conscious? There&#x27;s a lot of chatter about it on LinkedIn,
and I&#x27;m occasionally surprised to hear that the idea of a conscious
LLM is absurd because LLMs are mechanistically nothing like the
the consciousness of human brains. Because, well, neuroscience has
no idea how consciousness works! The front-running theory of
consciousness for the past two decades has been Gulio Tononi&#x27;s
Integrated Information Theory, and although it doesn&#x27;t have any
major competitors, it&#x27;s not universally accepted. Nowhere close.&lt;&#x2F;p&gt;
&lt;p&gt;If we don&#x27;t have a unified theory of consciousness, what do we have?
A large number of experiments that tell us discrete facts &lt;em&gt;about&lt;&#x2F;em&gt;
consciousness. Many of them deviate from the intuitions we have
about consciousness from our own introspection.&lt;&#x2F;p&gt;
&lt;p&gt;In this post I&#x27;d like to give you a bit of what neuroscience knows
about consciousness, and to convince you that the right attitude
to have about consciousness in LLMs is cautious agnosticism.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;warmup-brain-transplants&quot;&gt;Warmup - Brain Transplants&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s warm up your own consciousness with a thought experiment.
You&#x27;ve worked out the formula for cold fusion! Driving to the lab
in your excitement to share the results, you crash into another car.&lt;&#x2F;p&gt;
&lt;p&gt;You and your victim are in bad shape. The doctors tell you they&#x27;re
all set up to do the world&#x27;s first brain transplant. One body and one brain are going to go home tonight, the others unfortunately won&#x27;t. They just need to know one thing - would you rather be the
brain donor or the brain recipient?&lt;&#x2F;p&gt;
&lt;p&gt;Putting aside altruism for a moment, what&#x27;s the selfish choice?
It&#x27;s to be the donor, of course. &quot;You&quot; are the brain, more than
the rest of the body, so it&#x27;s more appropriate to think of this
operation as a body-and-face transplant, rather than a brain
transplant, since your identity certainly moves with your brain.
If you took the other choice and accepted a brain donation,
contratulations, your wonderful body lives on, but &quot;you&quot; aren&#x27;t
here to appreciate that fact. Oh, and that cold fusion formula
is gone, too.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;warmup-fragmented-consciousness-constructed-continuity&quot;&gt;Warmup - Fragmented Consciousness, Constructed Continuity&lt;&#x2F;h2&gt;
&lt;p&gt;One framework for consciousness suggested by psychophysics
experiments is that consciousness is discontinuous.
Although you experience yourself as existing smoothly through
every point in time that you are awake, your true conscious
experiences are deceptively fragmented. Visual illusions,
transcratial magnetic stimulation studies and brain
wave recordings suggest that we experience new percpepts 4-20
times a second. Each percept may embed the sense of motion
of objecects in your visual scene, but your conscious &quot;frame rate&quot;
is much lower (4Hz) than the frame rate available to the sensors
in your eyes (~200Hz). But the sense of continuity of conscious
experience was reconstcuted by your brain after the fact.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;&#x2F;images&#x2F;2025-10-24-chunked-consciousness.png&quot; alt=&quot;The two-stage model&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Test&lt;&#x2F;p&gt;
&lt;p&gt;If that&#x27;s hard to swallow, notice that post-hoc reconstruction
is extremely common. It&#x27;s easy to verify visually. Observe your
surroundings and get a sense of how clearly you see the room
you&#x27;re in. How many doors can you see? How many people, books?
These are easy questions to answer.
Now, pick a single object, and don&#x27;t force your eyes
to stay glued to it for 20 seconds. While locked on to that one
object, how much detail is still available to you? What I hope
you experience from this exercise is the difference between
intuition and reality for our perceptions. When our eyes move
freely, we get the impression that we have high-definition access
to the whole visual field. But when our eyes are stuck in place,
we recognize that only a tiny part of our visual field contains
useful information. The perception of full-field high resolution
is an illusion created after the fact through sensory memory.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;soul-transplants-and-identity&quot;&gt;Soul Transplants and Identity&lt;&#x2F;h2&gt;
&lt;p&gt;Even if consciosness exists in discrete chunks, what can we
say about how those chunks relate to one another? Another of
our core native beliefs about consciousness is that it&#x27;s
&quot;continuous&quot; in the sense of extending through time - it&#x27;s the
&quot;same&quot; conscious being that exists from moment to moment, maybe
not &quot;continuously&quot; in sense of being not-chunked, but at least
persistent and linked from chunk to chunk.&lt;&#x2F;p&gt;
&lt;p&gt;Let&#x27;s scrutinize this view though, with a thought experiment.
Assume the existence of a soul. Your soul is your consciousness,
and it is the thing links together your chunks of consciousness
into a narrative sequence. However, in this hypothetical, we are
still neuroscientists and we still recognize that physiological
things like synaptic strength and neuron dynamics are the
physical basis of both long-term, short-term and perceptual memory.&lt;&#x2F;p&gt;
&lt;p&gt;Now imagine that conscious soul could hop between bodies - trade
places for a moment with another soul and see through another&#x27;s
eyes. What would this feel like?&lt;&#x2F;p&gt;
&lt;p&gt;The answer depends on parameter that I haven&#x27;t specified, and which
you might not have questioned: are physiological processes the only
form or memory, or does the soul posess its own memory system that
is somehow either complementary or redundant with physiological
memory?&lt;&#x2F;p&gt;
&lt;p&gt;If all memory is physical, but there is a soul that experiences,
swapping souls would feel exactly like: &lt;em&gt;nothing&lt;&#x2F;em&gt;. When your
soul hops into a new body, it also hops into the existing &lt;em&gt;memories&lt;&#x2F;em&gt;,
and when your soul returns to your body, it once again encounters
only your body&#x27;s memories, carrying none of the other body&#x27;s memories
back with it.&lt;&#x2F;p&gt;
&lt;p&gt;In this magical trip to another brain and back, there wouldn&#x27;t a
single trace.&lt;&#x2F;p&gt;
&lt;p&gt;Now, if your soul somehow does have its own memory system, which
is somehow either complementary or redundant with the physical
memory systems, you would remember.&lt;&#x2F;p&gt;
&lt;p&gt;The point of this thought experiment isn&#x27;t to imagine souls or to
work out whether they have memory. It&#x27;s to point out how fragmented
our consciousness is, and how differently it exists, compared to
the two forms of continuity that we tacitly assume to be the
essential aspects of consciousness.&lt;&#x2F;p&gt;
&lt;p&gt;When you fully internalize this model, you may feel that you
have no more moral obligation to yourself than you do to any
other human. The fragment of consciousness is no the same
consciousness as the frament that exists right now. It&#x27;s a new
fragment that exists in the same physical body and has access
to the same set of memories.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-von-neuman-model-of-consciousness&quot;&gt;A Von-Neuman model of consciousness&lt;&#x2F;h2&gt;
&lt;p&gt;In this state of accepting consciousness as an essentially
discontinuous thing, only &lt;em&gt;appearing&lt;&#x2F;em&gt; smooth due to sensory
reconstruction and continuous moment-to-moment because of physical
memory, we can draw an analogy between human consciousness and
the von Neuman model of computation.&lt;&#x2F;p&gt;
&lt;p&gt;Consciousnes is bracketed into clock cycles. On every cycle,
it &quot;starts cold&quot; in the sense of having no non-physical memory,
rather it is dropped into a preexisting mode of long-term and
short-term memories. Just like your hypothetical soul inserted
into a new body experiences no shock of finding itself in a new
body. Consciousness is the logic processor in the CPU. Each clock
cycle it processes the instructions and manipulates the memory
in its registers and its RAM. The memory system is completely
separate from it and is the only thing providing continuity from
cycle to cycle.&lt;&#x2F;p&gt;
&lt;p&gt;Or for a different metaphor with the same flavor, consciousness
is the agentic LLM API. Every request you make encounteres a
fresh system. Continuity is supplied through the API request via
context engineering. It makes no difference at all if your first
agentic API request goes to a server farm in us-east-1 and the
following one goes to a server farm in jp-1. Neither the model
nor you can tell the difference.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>jj loves vibe coding</title>
          <pubDate>Fri, 10 Oct 2025 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://blog.greghale.io/posts/jj-for-vibe-coding/</link>
          <guid>https://blog.greghale.io/posts/jj-for-vibe-coding/</guid>
          <description xml:base="https://blog.greghale.io/posts/jj-for-vibe-coding/">&lt;p&gt;AI coding assistants have sped up our coding. Parallel agents
are dividing the development times down further. Version control
is becoming more of a bottleneck. By &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Amdahl%27s_law&quot;&gt;Amdahl&#x27;s Law&lt;&#x2F;a&gt; VCS is putting a new
fundamental limit on how fast software development can go. This isn&#x27;t
just an intuitive claim, it&#x27;s something that actively bugged me
at work and reminded me of an odd tool we used for &lt;em&gt;human&lt;&#x2F;em&gt; based
VCS at Kadena: &lt;code&gt;jj&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;So, while implementing a meaty feature for the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;boundaryml&#x2F;baml&quot;&gt;BAML&lt;&#x2F;a&gt; language with Claude Code, and
feeling the tedium of managing &lt;code&gt;git&lt;&#x2F;code&gt;&#x27;s staging area and branches,
I decided to dust off &lt;code&gt;jj&lt;&#x2F;code&gt; and try in this new AI coding context.
The results have been great. Here&#x27;s why:&lt;&#x2F;p&gt;
&lt;h2 id=&quot;1-automatic-change-tracking&quot;&gt;1. Automatic change tracking&lt;&#x2F;h2&gt;
&lt;p&gt;Long ago, you accepted the fact that you just have to run &lt;code&gt;git add&lt;&#x2F;code&gt;
for every changed file. Not with &lt;code&gt;jj&lt;&#x2F;code&gt;!
&lt;code&gt;jj&lt;&#x2F;code&gt; tracks all changes for you, a massive time saver when most of
your keystrokes are prompting the AI, rather than directly writing
source code.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;2-low-friction-commits&quot;&gt;2. Low-friction commits&lt;&#x2F;h2&gt;
&lt;p&gt;With &lt;code&gt;jj&lt;&#x2F;code&gt; you can create commits before the work, and changes get
written into that commit. It feels a bit like creating a directory,
then &lt;code&gt;cd&lt;&#x2F;code&gt;ing into that directory to create files there.&lt;&#x2F;p&gt;
&lt;p&gt;When you go back to &lt;code&gt;git&lt;&#x2F;code&gt; after this mindest change, you have the
opposite feeling: working with &lt;code&gt;git&lt;&#x2F;code&gt; feels creating a bunch of files,
then creating a folder, and moving files into the folder after the fact.&lt;&#x2F;p&gt;
&lt;p&gt;To highlight this difference in mindset: it&#x27;s extremely common for me to
write a prompt asking for a new work
item, realize this work should be in its own commit, and quickly run
&lt;code&gt;jj new&lt;&#x2F;code&gt; to open a new commit before Claude Code has finished
its reasoning and begun to write code. Having a zero-friction way to
chunk up work is pure joy.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;3-easy-commit-shuffling-rebasing&quot;&gt;3. Easy commit shuffling (rebasing)&lt;&#x2F;h2&gt;
&lt;p&gt;Rebasing is scary in &lt;code&gt;git&lt;&#x2F;code&gt; because it&#x27;s easy to rewrite history and
damage the repository. Rebases in &lt;code&gt;jj&lt;&#x2F;code&gt; are safe and common.&lt;&#x2F;p&gt;
&lt;p&gt;This is how you move a single commit to some other place in the history:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;jj rebase -r SOME_COMMIT --destination SOME_COMMIT
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Or move a whole series of commits to some other place in the
history:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;jj rebase --branch SOME_COMMIT --destination SOME_COMMIT
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;With parallel agents, rebasing is very common, and the improved
user experience in &lt;code&gt;jj&lt;&#x2F;code&gt; reduces rebase toil.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;4-easy-undo&quot;&gt;4. Easy Undo&lt;&#x2F;h2&gt;
&lt;p&gt;Whatever you just did in &lt;code&gt;jj&lt;&#x2F;code&gt;, if you realize it didn&#x27;t go the way
you expected, &lt;code&gt;undo&lt;&#x2F;code&gt; has you covered:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;jj undo
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Especially helpful while you&#x27;re still learning the ropes. A lot of noise
is made about ChatGPT stealing traffic from StackOverflow. &lt;code&gt;jj&lt;&#x2F;code&gt;
will cut into this market share further by removing the need to search
for how to undo all the different &lt;code&gt;git&lt;&#x2F;code&gt; accidents that happen in
work projects.&lt;&#x2F;p&gt;
&lt;p&gt;If the AI goes down a bad path and writes a bunch of code you dislike,
&lt;code&gt;abandon&lt;&#x2F;code&gt; abandons the work item.&lt;&#x2F;p&gt;
&lt;p&gt;Abandon the current commit:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;jj abandon
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Abandon some other commit in the history:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;jj abandon -r SOME_COMMIT
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And if you forgot to introduce a new commit before starting the agent
on a coding task unrelated to one you had in-progress, it&#x27;s easy
to split the work into two separate commits:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;jj split TASK_2_FILE_1.hs TASK_2_FILE_2.hs
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;jj-loves-vibe-coding&quot;&gt;jj loves vibe coding&lt;&#x2F;h1&gt;
&lt;p&gt;Running &lt;code&gt;jj&lt;&#x2F;code&gt; feels like &quot;managing&quot; something:
high level, details-managed-for-you, simple. Running &lt;code&gt;git&lt;&#x2F;code&gt;
feels like &quot;implementing&quot; something. Low level, down in the
weeds, wrestling with the tools.&lt;&#x2F;p&gt;
&lt;p&gt;Vibe coding is managing a coding assistant, so &lt;code&gt;jj&lt;&#x2F;code&gt; is a great fit.&lt;&#x2F;p&gt;
&lt;p&gt;The purpose of this blog post is to summarize why I like
&lt;code&gt;jj&lt;&#x2F;code&gt; for vibe coding, not to provide a balanced comparison
between &lt;code&gt;jj&lt;&#x2F;code&gt; and &lt;code&gt;git&lt;&#x2F;code&gt;. That&#x27;s why I&#x27;ve said nothing good about &lt;code&gt;git&lt;&#x2F;code&gt;
here and nothing bad about &lt;code&gt;jj&lt;&#x2F;code&gt;. When considering whether to adopt &lt;code&gt;jj&lt;&#x2F;code&gt;
at work or for your personal projects, of course you&#x27;ll need
to try it yourself and read some tutorials.&lt;&#x2F;p&gt;
&lt;p&gt;Here are a few things to know if you&#x27;re hearing about &lt;code&gt;jj&lt;&#x2F;code&gt; for the
first time and considering a switch:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;jj&lt;&#x2F;code&gt; is compatible with &lt;code&gt;git&lt;&#x2F;code&gt; and uses the &lt;code&gt;.git&lt;&#x2F;code&gt; directory for
tracking repository state. So you can freely use &lt;code&gt;jj&lt;&#x2F;code&gt; even if
the rest of the team uses &lt;code&gt;git&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;jj&lt;&#x2F;code&gt; has a learning curve! It&#x27;s easier to learn than &lt;code&gt;git&lt;&#x2F;code&gt;, but
not trivial. It took me a few weeks to reach the same
level of productivity that I built up over many years using
&lt;code&gt;git&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;li&gt;There is an excellent &lt;a href=&quot;https:&#x2F;&#x2F;steveklabnik.github.io&#x2F;jujutsu-tutorial&#x2F;&quot;&gt;tutorial from Steve Klabnik&lt;&#x2F;a&gt; and an excellent
&lt;a href=&quot;https:&#x2F;&#x2F;www.youtube.com&#x2F;watch?v=2otjrTzRfVk&amp;amp;t=327s&quot;&gt;video from Chris Krycho&lt;&#x2F;a&gt;.&lt;&#x2F;li&gt;
&lt;li&gt;Get started at the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;jj-vcs&#x2F;jj&quot;&gt;jj GitHub repo&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;we-have-coding-assistants-so-why-learn-a-new-tool&quot;&gt;We have coding assistants - so why learn a new tool?&lt;&#x2F;h2&gt;
&lt;p&gt;As someone who works on &lt;a href=&quot;https:&#x2F;&#x2F;boundaryml.com&quot;&gt;developer tools&lt;&#x2F;a&gt; at
the twilight of humanity&#x27;s involvement in the software development
process, I&#x27;ve worried about the utility of learning new tools,
writing new languages, or making any bets on human productivity.
Isn&#x27;t it better to move back to languages and
tools with billions of tokens on the internet for training LLMs, if
LLMs will be writing all the code?&lt;&#x2F;p&gt;
&lt;p&gt;Well, new languages and tools &lt;em&gt;are&lt;&#x2F;em&gt; coming out. And the complete AI
takeover of software engineering is happening over several years,
not several months. So I do still have to write code and collaborate
with people.&lt;&#x2F;p&gt;
&lt;p&gt;There is a trend among my programmer friends: the ones who are
the best at &lt;code&gt;git&lt;&#x2F;code&gt; tend to be the most excited about &lt;code&gt;jj&lt;&#x2F;code&gt;. &lt;strong&gt;Interesting&lt;&#x2F;strong&gt;.
&lt;code&gt;git&lt;&#x2F;code&gt; power users had conquered all &lt;code&gt;git&lt;&#x2F;code&gt;&#x27;s complexities.
They understood the underlying model, were unbothered the differences
between the commands for creating and deleting branches, knew all the
different and unrelated jobs done by &lt;code&gt;git checkout&lt;&#x2F;code&gt;, and had bookmarked
the StackOverflow pages for removing a change from the staging area.&lt;&#x2F;p&gt;
&lt;p&gt;You might think a &lt;code&gt;git&lt;&#x2F;code&gt; guru would be the last person who wants to
relinquish all that muscle memory and switch to a new tool and an
new set of commands to memorize for version control. &lt;strong&gt;Nope&lt;&#x2F;strong&gt;. Those
colleagues have had their tastes and sensibilities forged in the crucible
of &lt;code&gt;git&lt;&#x2F;code&gt;, and when &lt;code&gt;jj&lt;&#x2F;code&gt; arrived, they immediately saw the value and
accepted the switch cost. They fell in love and started making
slide decks and blog posts to try to convince their friends to use
it too.&lt;&#x2F;p&gt;
&lt;p&gt;Some developers (even some great developers!) who don&#x27;t self-identify
as &lt;code&gt;git&lt;&#x2F;code&gt; gurus are likely to ask Claude Code to turn a vibe-coded
work item into a &lt;code&gt;git&lt;&#x2F;code&gt; commit - meaning they&#x27;ll prefer to prompt
&quot;add all the files to git and commit and push it to github&quot;, instead
of running &lt;code&gt;git&lt;&#x2F;code&gt; manually. It&#x27;s a wonderful finding that
Claude is trustworthy enough to drive &lt;code&gt;git&lt;&#x2F;code&gt; for us, but it&#x27;s also
an indigtment of the &lt;code&gt;git&lt;&#x2F;code&gt; user interface.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Frosted Vertical Reflections in ffmpeg</title>
          <pubDate>Sat, 20 Jan 2024 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://blog.greghale.io/posts/video-reflection/</link>
          <guid>https://blog.greghale.io/posts/video-reflection/</guid>
          <description xml:base="https://blog.greghale.io/posts/video-reflection/">&lt;h1 id=&quot;creating-the-frosted-reflection-effect-for-videos&quot;&gt;Creating the &quot;frosted reflection&quot; effect for videos&lt;&#x2F;h1&gt;
&lt;p&gt;I recently wanted to include a screenshot of NeuronBench into the landing page,
with the classic &quot;frosted reflection&quot; effect, where a hint of the image is
reflected just below the image. I normally do this is Gimp, but my NeuronBench
screenshot was actually a screen recording (video), and I wasn&#x27;t about to repeat
this tedious process frame-by-frame.&lt;&#x2F;p&gt;
&lt;p&gt;The final result is here:&lt;&#x2F;p&gt;
&lt;video width=&quot;420&quot;
       autoplay
       loop
       muted&gt;
    &lt;source src=&quot;&amp;#x2F;images&amp;#x2F;frosted.mp4&quot; type=&quot;video&#x2F;mp4&quot;&gt;
    Your browser does not support the video tag.
&lt;&#x2F;video&gt;
&lt;p&gt;This blog post records the process, mostly as a record for me in case
I need to do it again in the future, or in case someone else finds the
style interesting and wants to replicate it.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;dependencies&quot;&gt;Dependencies&lt;&#x2F;h1&gt;
&lt;ul&gt;
&lt;li&gt;MacOS&lt;&#x2F;li&gt;
&lt;li&gt;QuickTime&lt;&#x2F;li&gt;
&lt;li&gt;ffmpeg&lt;&#x2F;li&gt;
&lt;li&gt;gimp&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h1 id=&quot;process&quot;&gt;Process&lt;&#x2F;h1&gt;
&lt;ol&gt;
&lt;li&gt;Clean background: In the system settings, set the Wallpaper to solid white,
matching the background color of the webpage where I&#x27;ll embed this video.
Then clear most of the desktop icons off of the desktop.&lt;&#x2F;li&gt;
&lt;li&gt;Run the app: In my case: &lt;code&gt;cargo run --bin bevy --release&lt;&#x2F;code&gt;.&lt;&#x2F;li&gt;
&lt;li&gt;Take the screen capture: In QuickTime, close the default file-chooser modal
and select &lt;code&gt;File &amp;gt; New Screen Recording&lt;&#x2F;code&gt;. Frame the application window with
generous space (avoid clipping the shadow dropped by the window). Click the
&quot;Stop&quot; icon in the menu bar when done.&lt;&#x2F;li&gt;
&lt;li&gt;Trim the time: &lt;code&gt;Edit &amp;gt; Trim&lt;&#x2F;code&gt; in QuickTime. Save.&lt;&#x2F;li&gt;
&lt;li&gt;Crop the video:&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;ffmpeg -i screengrab_trimmed.mov  -filter:v &amp;quot;crop=1332:1200:0:0&amp;quot; -c:a copy screengrab_cropped.mov
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;Apply the gaussian blur, flip and composite:&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;ffmpeg -i screengrab_cropped.mov -filter_complex &amp;quot;[0:v] split [original][mirror]; [mirror] vflip, gblur=sigma=10 [flipped]; [original][flipped] vstack&amp;quot; output.mov
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
At this point, we have a stack of the original screen grab, with its mirror image blurred beneath.
Next we need that blurred mirror image to fade to white.&lt;&#x2F;li&gt;
&lt;li&gt;Determine the image dimensions:&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of default=noprint_wrappers=1 output.mov
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
We will use this to create our gratient as a .png file with matching size in Gimp.&lt;&#x2F;li&gt;
&lt;li&gt;Create a gradient that goes from transparent to solid white, starting at the top
of the mirrored image and ending 20-40 pixels lower.&lt;&#x2F;li&gt;
&lt;li&gt;Overlay the gradient onto the movie.&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;ffmpeg -i output.mov -i gradient.png -filter_complex &amp;quot;overlay=0:main_h-overlay_h&amp;quot; output2.mov
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;Trim excess vertical pixels from the video, now that much of the bottom mirror is masked off.&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;h1 id=&quot;improvements&quot;&gt;Improvements&lt;&#x2F;h1&gt;
&lt;p&gt;The space between the original window and its refelction looks muddy. This is because the original screen
grab included the dropped shadow from MacOS, which gets copied and flipped in the above process. The final
result would be much cleaner if the space between were clear of shadows. And it would be more semantically
consistent without the shadow, because the &quot;floor&quot; in our effect is below the screenshot (where our
reflection lands), not behind the screenshot (where the shadow is).&lt;&#x2F;p&gt;
&lt;p&gt;In the two versions of MacOS I&#x27;m running (Ventura and Sonoma), there is no configuration option to turn off
this shadow. And I can&#x27;t simply use cropping at the first preprocessing step to crop out the shadow, because
the window is a rounded rectangle - some awkward shadow would remain in the corners.&lt;&#x2F;p&gt;
&lt;p&gt;So I could either (a) create a masking image in gimp - a rounded-rectangle frame - matching the size of
the screengrab window, and apply this during prepressing, or (b) perform my screen recording on a
linux machine.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Claude 2.1 correctly interprets a neural network</title>
          <pubDate>Thu, 23 Nov 2023 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://blog.greghale.io/posts/claude-winner-takes-all/</link>
          <guid>https://blog.greghale.io/posts/claude-winner-takes-all/</guid>
          <description xml:base="https://blog.greghale.io/posts/claude-winner-takes-all/">&lt;h2 id=&quot;prologue&quot;&gt;Prologue&lt;&#x2F;h2&gt;
&lt;p&gt;In my &lt;a href=&quot;https:&#x2F;&#x2F;blog.greghale.io&#x2F;posts&#x2F;claude-winner-takes-all&#x2F;2023-03-24-gpt4-neuron-schema.html&quot;&gt;last post&lt;&#x2F;a&gt;, ChatGPT and I worked through some
ideas for domain specific languages (DSLs) for describing biologically realistic neural networks.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;anthropic.com&quot;&gt;Anthropic&lt;&#x2F;a&gt;&#x27;s &lt;a href=&quot;https:&#x2F;&#x2F;claude.ai&quot;&gt;Claude-2&lt;&#x2F;a&gt; has come on the scene
as another amazingly powerful chat assistant, and I wondered if I could give in the inverse
problem - taking a neural network defined in a brand new DSL and asking Claude to tell
me what it could about the high level properties of the network.&lt;&#x2F;p&gt;
&lt;p&gt;tl;dr: I believe that the DSL is fairly readable and self-describing... but
without comments it&#x27;s not obvious what the the author&#x27;s intention was and what
the resulting network should do. To my amazement, Claude was able to see through
the syntax (which is completely novel - this is not a DSL used in the wild
anywhere yet), and understand the high-level dynamics of the network.&lt;&#x2F;p&gt;
&lt;p&gt;I won&#x27;t say what the goal of the network is here, I hope you&#x27;ll try to work that out for
yourself as you read my conversation with Claude. Are you smarter than the chat bot?
I&#x27;m not. :)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-claude-chat-session&quot;&gt;The Claude chat session&lt;&#x2F;h2&gt;
&lt;h4 id=&quot;greg&quot;&gt;Greg:&lt;&#x2F;h4&gt;
&lt;p&gt;Could you guess what the high-level properties of this neural network are?&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;let pos = .&#x2F;neuron_position.ffg
&lt;&#x2F;span&gt;&lt;span&gt;let params = {
&lt;&#x2F;span&gt;&lt;span&gt;      n_clusters: (4 : Natural),
&lt;&#x2F;span&gt;&lt;span&gt;      n_excitatory_per_cluster: (5 : Natural)
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;let n_inhibitory_per_cluster = params.n_clusters -- 1
&lt;&#x2F;span&gt;&lt;span&gt;let n_neurons_per_cluster = params.n_excitatory_per_cluster + params.n_clusters -- 1
&lt;&#x2F;span&gt;&lt;span&gt;let prelude = https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;reuron&#x2F;reuron-io&#x2F;main&#x2F;prelude&#x2F;package.ffg
&lt;&#x2F;span&gt;&lt;span&gt;let excitatory_neuron = .&#x2F;excitatory_neuron.ffg
&lt;&#x2F;span&gt;&lt;span&gt;let inhibitory_neuron = .&#x2F;inhibitory_neuron.ffg
&lt;&#x2F;span&gt;&lt;span&gt;let excitatory_synapse = .&#x2F;excitatory_synapse.ffg
&lt;&#x2F;span&gt;&lt;span&gt;let inhibitory_synapse = .&#x2F;inhibitory_synapse.ffg
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;let cluster_neurons = \cluster -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;  prelude.list.generate params.n_excitatory_per_cluster (\i -&amp;gt; {
&lt;&#x2F;span&gt;&lt;span&gt;    location: pos cluster true i,
&lt;&#x2F;span&gt;&lt;span&gt;    neuron: excitatory_neuron [],
&lt;&#x2F;span&gt;&lt;span&gt;    stimulator_segments: []
&lt;&#x2F;span&gt;&lt;span&gt;  }) + prelude.list.generate n_inhibitory_per_cluster (\i -&amp;gt; {
&lt;&#x2F;span&gt;&lt;span&gt;    location: pos cluster false i,
&lt;&#x2F;span&gt;&lt;span&gt;    neuron: inhibitory_neuron [],
&lt;&#x2F;span&gt;&lt;span&gt;    stimulator_segments: []
&lt;&#x2F;span&gt;&lt;span&gt;  })
&lt;&#x2F;span&gt;&lt;span&gt;let neurons =
&lt;&#x2F;span&gt;&lt;span&gt;  prelude.list.concat
&lt;&#x2F;span&gt;&lt;span&gt;  (prelude.list.generate params.n_clusters cluster_neurons)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;let cluster_excitatory_synapses = \cluster -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;  prelude.list.generate params.n_excitatory_per_cluster
&lt;&#x2F;span&gt;&lt;span&gt;  (\local_id -&amp;gt; 
&lt;&#x2F;span&gt;&lt;span&gt;   let global_offset = cluster * n_neurons_per_cluster
&lt;&#x2F;span&gt;&lt;span&gt;   let local_next = Natural&#x2F;mod (local_id + 1) params.n_excitatory_per_cluster
&lt;&#x2F;span&gt;&lt;span&gt;   in
&lt;&#x2F;span&gt;&lt;span&gt;   [Synapse {
&lt;&#x2F;span&gt;&lt;span&gt;    pre_neuron: global_offset + local_id,
&lt;&#x2F;span&gt;&lt;span&gt;    pre_segment: 1,
&lt;&#x2F;span&gt;&lt;span&gt;    post_neuron: global_offset + local_next,
&lt;&#x2F;span&gt;&lt;span&gt;    post_segment: 10,
&lt;&#x2F;span&gt;&lt;span&gt;    synapse_membranes: excitatory_synapse
&lt;&#x2F;span&gt;&lt;span&gt;  }] + 
&lt;&#x2F;span&gt;&lt;span&gt;  prelude.list.concat
&lt;&#x2F;span&gt;&lt;span&gt;    (prelude.list.generate params.n_excitatory_per_cluster
&lt;&#x2F;span&gt;&lt;span&gt;      (\e -&amp;gt; prelude.list.generate n_inhibitory_per_cluster
&lt;&#x2F;span&gt;&lt;span&gt;       (\i -&amp;gt; Synapse {
&lt;&#x2F;span&gt;&lt;span&gt;         pre_neuron: global_offset + e,
&lt;&#x2F;span&gt;&lt;span&gt;         pre_segment: 1,
&lt;&#x2F;span&gt;&lt;span&gt;         post_neuron: global_offset + params.n_excitatory_per_cluster + i,
&lt;&#x2F;span&gt;&lt;span&gt;         post_segment: 10,
&lt;&#x2F;span&gt;&lt;span&gt;         synapse_membranes: excitatory_synapse
&lt;&#x2F;span&gt;&lt;span&gt;       } 
&lt;&#x2F;span&gt;&lt;span&gt;      ))
&lt;&#x2F;span&gt;&lt;span&gt;    )
&lt;&#x2F;span&gt;&lt;span&gt;  )
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;let excitatory_synapses = prelude.list.concat
&lt;&#x2F;span&gt;&lt;span&gt;  (prelude.list.concat
&lt;&#x2F;span&gt;&lt;span&gt;    (prelude.list.generate params.n_clusters
&lt;&#x2F;span&gt;&lt;span&gt;      (\c -&amp;gt; cluster_excitatory_synapses c)))
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;let cluster_inhibitory_synapses = \cluster -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;  let source_offset = (cluster * n_neurons_per_cluster) + params.n_excitatory_per_cluster
&lt;&#x2F;span&gt;&lt;span&gt;  in
&lt;&#x2F;span&gt;&lt;span&gt;  prelude.list.generate params.n_clusters
&lt;&#x2F;span&gt;&lt;span&gt;  (\target_cluster -&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    if Natural&#x2F;equal cluster target_cluster
&lt;&#x2F;span&gt;&lt;span&gt;    then []
&lt;&#x2F;span&gt;&lt;span&gt;    else
&lt;&#x2F;span&gt;&lt;span&gt;      let target_offset =
&lt;&#x2F;span&gt;&lt;span&gt;        target_cluster * (params.n_excitatory_per_cluster + n_inhibitory_per_cluster)
&lt;&#x2F;span&gt;&lt;span&gt;      in
&lt;&#x2F;span&gt;&lt;span&gt;      prelude.list.concat
&lt;&#x2F;span&gt;&lt;span&gt;      (prelude.list.generate n_inhibitory_per_cluster
&lt;&#x2F;span&gt;&lt;span&gt;       (\i -&amp;gt; prelude.list.generate params.n_excitatory_per_cluster
&lt;&#x2F;span&gt;&lt;span&gt;        (\e -&amp;gt; Synapse {
&lt;&#x2F;span&gt;&lt;span&gt;          pre_neuron: source_offset + i,
&lt;&#x2F;span&gt;&lt;span&gt;          pre_segment: 1,
&lt;&#x2F;span&gt;&lt;span&gt;          post_neuron: target_offset + e,
&lt;&#x2F;span&gt;&lt;span&gt;          post_segment: 1,
&lt;&#x2F;span&gt;&lt;span&gt;          synapse_membranes: inhibitory_synapse
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;        )
&lt;&#x2F;span&gt;&lt;span&gt;       )
&lt;&#x2F;span&gt;&lt;span&gt;      )
&lt;&#x2F;span&gt;&lt;span&gt;  )
&lt;&#x2F;span&gt;&lt;span&gt;let inhibitory_synapses =
&lt;&#x2F;span&gt;&lt;span&gt;  prelude.list.concat
&lt;&#x2F;span&gt;&lt;span&gt;    (prelude.list.concat
&lt;&#x2F;span&gt;&lt;span&gt;      (prelude.list.generate params.n_clusters cluster_inhibitory_synapses))
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;in
&lt;&#x2F;span&gt;&lt;span&gt;  Scene {
&lt;&#x2F;span&gt;&lt;span&gt;    neurons: neurons,
&lt;&#x2F;span&gt;&lt;span&gt;    synapses: excitatory_synapses + inhibitory_synapses
&lt;&#x2F;span&gt;&lt;span&gt;  }
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;hr&#x2F;&gt;
&lt;h4 id=&quot;claude&quot;&gt;Claude:&lt;&#x2F;h4&gt;
&lt;p&gt;Based on the code provided, I can infer the following high-level properties about this neural network:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;It consists of multiple clusters of neurons. The number of clusters is defined by the &lt;code&gt;n_clusters&lt;&#x2F;code&gt; parameter.&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;Each cluster contains excitatory and inhibitory neurons. The number of excitatory neurons per cluster is defined by &lt;code&gt;n_excitatory_per_cluster&lt;&#x2F;code&gt;. There is one less inhibitory neuron than the number of clusters.&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;The excitatory neurons within a cluster are connected to each other in a ring topology.&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;The excitatory neurons in a cluster connect to all the inhibitory neurons in that same cluster.&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;The inhibitory neurons in a cluster connect to the excitatory neurons in all other clusters.&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;It uses separate neuron and synapse definitions that are loaded from different files. This allows customization and reuse of those components.&lt;&#x2F;p&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;So in summary, it&#x27;s a clustered network with local excitation and lateral inhibition between clusters. The connectivity rules differ for excitatory and inhibitory neurons. The number of clusters and the sizing of each cluster can be configured through parameters.&lt;&#x2F;p&gt;
&lt;hr&#x2F;&gt;
&lt;h4 id=&quot;greg-1&quot;&gt;Greg:&lt;&#x2F;h4&gt;
&lt;p&gt;What sort of network is it? Can you describe the properties of the clusters?&lt;&#x2F;p&gt;
&lt;hr&#x2F;&gt;
&lt;h4 id=&quot;claude-1&quot;&gt;Claude:&lt;&#x2F;h4&gt;
&lt;p&gt;Based on the additional details in the code, I can provide some more specifics about the network and cluster properties:&lt;&#x2F;p&gt;
&lt;p&gt;Type of Network:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Clustered recurrent neural network&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Cluster Properties:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Number of clusters: Configurable via the &lt;code&gt;n_clusters&lt;&#x2F;code&gt; parameter&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Example shows 4 clusters&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;Neurons per cluster:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Excitatory neurons: Configurable via &lt;code&gt;n_excitatory_per_cluster&lt;&#x2F;code&gt;
&lt;ul&gt;
&lt;li&gt;Example shows 5 excitatory neurons per cluster&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;Inhibitory neurons:
&lt;ul&gt;
&lt;li&gt;Number is always 1 less than &lt;code&gt;n_clusters&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;This allows inhibitory connections between all clusters&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;Connectivity:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Excitatory-Excitatory:
&lt;ul&gt;
&lt;li&gt;Within cluster: Ring topology&lt;&#x2F;li&gt;
&lt;li&gt;Between clusters: No connections&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;Excitatory-Inhibitory:
&lt;ul&gt;
&lt;li&gt;Within cluster: Fully connected&lt;&#x2F;li&gt;
&lt;li&gt;Between clusters: No connections&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;Inhibitory-Excitatory:
&lt;ul&gt;
&lt;li&gt;Within cluster: No connections&lt;&#x2F;li&gt;
&lt;li&gt;Between clusters: Fully connected&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;So in summary, each cluster contains a small, locally recurrent network of excitatory neurons, along with a pool of inhibitory neurons that connect globally between clusters for competition&#x2F;inhibition. The sizes of clusters and pool of inhibitions can be adjusted.&lt;&#x2F;p&gt;
&lt;p&gt;Does this help characterize the key properties of the clusters and overall network architecture? Let me know if you need any clarification or have additional questions!&lt;&#x2F;p&gt;
&lt;hr&#x2F;&gt;
&lt;h4 id=&quot;greg-2&quot;&gt;Greg:&lt;&#x2F;h4&gt;
&lt;p&gt;Could you give a high-level description of the network&#x27;s behavior? If you had to produce a catchy title for this network (as opposed to other topologies), what would you choose?&lt;&#x2F;p&gt;
&lt;hr&#x2F;&gt;
&lt;h4 id=&quot;claude-2&quot;&gt;Claude:&lt;&#x2F;h4&gt;
&lt;p&gt;Here is a high-level description of the expected network behavior:&lt;&#x2F;p&gt;
&lt;p&gt;&quot;Competitive Clustered Recurrent Network&quot;&lt;&#x2F;p&gt;
&lt;p&gt;This network consists of multiple locally recurrent clusters that compete and
inhibit each other via a global pool of inhibitory neurons. As such, it behaves
as a series of interconnected attractor networks that maintain their own
internal representations, while suppressing the activity of the other clusters.&lt;&#x2F;p&gt;
&lt;p&gt;Some key behavioral properties:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#2b303b;color:#c0c5ce;&quot;&gt;&lt;code&gt;&lt;span&gt;Within a cluster, the excitatory-excitatory recurrence allows maintenance of
&lt;&#x2F;span&gt;&lt;span&gt;an active representation or &amp;quot;memory&amp;quot; in that module after the input is removed.
&lt;&#x2F;span&gt;&lt;span&gt;The inhibitory connections between clusters implement a winner-take-all type
&lt;&#x2F;span&gt;&lt;span&gt;computation, where the most strongly activated cluster will suppress activity
&lt;&#x2F;span&gt;&lt;span&gt;in the other clusters.
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;This allows multiple separate representations to be held simultaneously across
&lt;&#x2F;span&gt;&lt;span&gt;the different recurrent clusters. The global inhibition supports competition
&lt;&#x2F;span&gt;&lt;span&gt;between representations held in different clusters depending on the vigor of
&lt;&#x2F;span&gt;&lt;span&gt;the activity, novelty, or other salient features.
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In summary, the modular and competitive design allows this network to maintain
multiple context-dependent memories or rules simultaneously, while utilizing a
global suppression mechanism to dictate which module is currently dominating the
overall network output. The recurrent excitation supports working memory within
each module.&lt;&#x2F;p&gt;
&lt;p&gt;Let me know if this helps characterize the overall purpose and high-level behavior you might expect from this type of competitive and clustered recurrent network architecture. I&#x27;m happy to clarify or expand my explanation further as needed!&lt;&#x2F;p&gt;
&lt;hr&#x2F;&gt;
&lt;h4 id=&quot;greg-3&quot;&gt;Greg:&lt;&#x2F;h4&gt;
&lt;p&gt;You are absolutely amazing.&lt;&#x2F;p&gt;
&lt;hr&#x2F;&gt;
&lt;h4 id=&quot;claude-3&quot;&gt;Claude:&lt;&#x2F;h4&gt;
&lt;p&gt;Thank you! I&#x27;m pleased I could provide an accurate and intuitive
characterization of this network architecture. Being able to infer high-level
behaviors and properties from code details is an important skill in AI, so your
positive feedback tells me I&#x27;m making good progress. Interpreting and explaining
complex systems clearly and concisely to humans is something I strive to improve
at. I appreciate you taking the time to have this conversation with me - it
really helps further my understanding.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;Conclusion&lt;&#x2F;h2&gt;
&lt;p&gt;Claude appears to have immediately understood the network topology, recognizing
it ask as a &quot;Competitive Clustered Recurrent Network&quot;. (I wolud call it a
&quot;winner-takes-all&quot; network, same difference). It was able to infer the fact that
excitatory connections within a cluster form a ring, and inhibitory connections
between clusters are all-to-all.&lt;&#x2F;p&gt;
&lt;p&gt;The network&#x27;s flat neuron list makes deciphering connectivity hard, as finding
synapses between clusters requires complex index computations. Those
computations are easy enough to implement, but quite hard to interpret
post-facto without code comments.&lt;&#x2F;p&gt;
&lt;p&gt;Oh, and each Claude answer came out in less than three seconds.. It&#x27;s all enough
to make my biologically realistic neurons (the actual ones in my own head, I
mean) start to feel like they&#x27;re not necessarily the smartest things around
anymore.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Vertigo Chart</title>
          <pubDate>Wed, 25 Jan 2023 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://blog.greghale.io/posts/vertigo-chart/</link>
          <guid>https://blog.greghale.io/posts/vertigo-chart/</guid>
          <description xml:base="https://blog.greghale.io/posts/vertigo-chart/">&lt;h1 id=&quot;vertigo-chart&quot;&gt;Vertigo Chart&lt;&#x2F;h1&gt;
&lt;p&gt;This chart tracks my ongoing vertigo symptoms and some other factors that might be triggers.&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;a href=&quot;&#x2F;data&#x2F;vertigo-chart.csv&quot;&gt;raw data&lt;&#x2F;a&gt; is available in csv. It is always up to date with the chart.&lt;&#x2F;p&gt;
&lt;div id=&quot;vertigo&quot; style=&quot;width:700px;height:700px;&quot;&gt;&lt;&#x2F;div&gt;
&lt;div style=&quot;font-size:8pt;&quot;&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Trace&lt;&#x2F;th&gt;&lt;th&gt;Description&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;discomfort&lt;&#x2F;td&gt;&lt;td&gt;How much vertigo I&#x27;m feeling&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;hints&lt;&#x2F;td&gt;&lt;td&gt;Number of subtle warning signs, e.g. a little bout of nystagmus&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;sleep_deficit_8hr&lt;&#x2F;td&gt;&lt;td&gt;Shortage of 8 hours sleep the night prior&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;sore_throat&lt;&#x2F;td&gt;&lt;td&gt;Sore throat (to track if illness is related)&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;headache&lt;&#x2F;td&gt;&lt;td&gt;Headache (to track if illness is related)&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;stress&lt;&#x2F;td&gt;&lt;td&gt;Subjective 1 is a typical day, 7 is a tough prod incident&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;caffine&lt;&#x2F;td&gt;&lt;td&gt;Equivalent to how many caffinated teas I had that day&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;sugar&lt;&#x2F;td&gt;&lt;td&gt;Subjective 1-10 scale from just a bowl of cereal to 5 bowls of ice cream&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;salt&lt;&#x2F;td&gt;&lt;td&gt;Subjective 1-10 scale from very little to tons of salt&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;dh_left&lt;&#x2F;td&gt;&lt;td&gt;How much spinning is produced by doing a left Dix-Hallpike&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;dh_right&lt;&#x2F;td&gt;&lt;td&gt;How much spinning is produced by doing a right Dix-Hallpike&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;accel_ul&lt;&#x2F;td&gt;&lt;td&gt;How much does tilting my head up and left feel like it&#x27;s happening too fast&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;accel_dr&lt;&#x2F;td&gt;&lt;td&gt;How much does tilting my head down and right feel like it&#x27;s happening too fast&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;accel_ur&lt;&#x2F;td&gt;&lt;td&gt;How much does tilting my head up and right feel like it&#x27;s happening too fast&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;accel_dl&lt;&#x2F;td&gt;&lt;td&gt;How much does tilting my head down and left feel like it&#x27;s happening too fast&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;h_loss_l&lt;&#x2F;td&gt;&lt;td&gt;0-10 scale of subjective left hearing loss and tinnitus&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;h_loss_r&lt;&#x2F;td&gt;&lt;td&gt;0-10 scale of subjective right hearing loss and tinnitus&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;&#x2F;div&gt;
&lt;script src=&quot;https:&#x2F;&#x2F;cdn.plot.ly&#x2F;plotly-2.18.0.min.js&quot;&gt;&lt;&#x2F;script&gt;
&lt;script language=&quot;javascript&quot;&gt;

function makeplot() {
  d3.csv(&quot;&#x2F;data&#x2F;vertigo-chart.csv&quot;, data =&gt; plotTransposedData(data))
}

function isATrace(propt) {
  return propt != &quot;datetime&quot;
}

function proptVisibility(propt) {
  if (propt == &quot;discomfort&quot;) {
    return true
  } else {
    return &#x27;legendonly&#x27;
  }
}
    
function plotTransposedData(allRows) {
  var traces = {};
  
  for (var propt in allRows[0]) {
    if (isATrace(propt)) {
      traces[propt] = {};
      traces[propt].name = propt;
      traces[propt].visible = proptVisibility(propt);
      traces[propt].x = [];
      traces[propt].y = [];
    }
  }
  
  for (var i=0; i &lt; allRows.length; i++) {
    for (var propt in allRows[i] ) {
      if (isATrace(propt)) {
        traces[propt].x.push(allRows[i].datetime);
        traces[propt].y.push(allRows[i][propt]);
      }
    }
  }
  
  var traceList = [];
  for (var propt in traces) {
    traceList.push(traces[propt]);
  }
  
  var plotDiv = document.getElementById(&#x27;vertigo&#x27;);
  Plotly.newPlot(
    plotDiv,
    traceList,
    {
      margin: {t: 0},
      yaxis: {fixedrange: true},
      margin: { r: 50 },
      modebar: {
        orientation: &#x27;v&#x27;
      }
    });

}

makeplot();

&lt;&#x2F;script&gt;
</description>
      </item>
      <item>
          <title>Vertigo</title>
          <pubDate>Fri, 20 Dec 2019 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://blog.greghale.io/posts/vertigo/</link>
          <guid>https://blog.greghale.io/posts/vertigo/</guid>
          <description xml:base="https://blog.greghale.io/posts/vertigo/">&lt;p&gt;In April 2019, I came down with a nasty case of vertigo. The acute phase lasted
a month, and after that it would come and go, never reaching the original peak
but also never recovering fully. After a long journey with several specialists,
an otolaryngologist at Johns Hopkins cracked the case, and my Vertigo journey
ended. Mostly. Along the way, I learned a surprising amount of fun science. In
this blog post, I&#x27;ll share a bit about those learning and how this disease
felt.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-symptoms&quot;&gt;The symptoms&lt;&#x2F;h2&gt;
&lt;p&gt;The main symptom of vertigo is the spinning and dizziness. Being dizzy can be
fun for a while, but of course it gets old quickly. The chronic dizziness of
Vertigo makes it difficult to work or care for kids. Driving was impossible.&lt;&#x2F;p&gt;
&lt;div id=&quot;vertigo-simulator&quot;&gt;&lt;&#x2F;div&gt;
&lt;p&gt;&quot;&lt;em&gt;Thanks, I hate it&lt;&#x2F;em&gt;&quot; is the correct reaction.&lt;&#x2F;p&gt;
&lt;p&gt;Even when the world was not spinning, my head never felt fully fixed in space.
The sensation is hard to describe - imagine objects in the distance always
vibrating just a little bit.&lt;&#x2F;p&gt;
&lt;p&gt;The last symptom I felt is much harder to describe. It&#x27;s something like
electrical noise or static. There&#x27;s no actual sound, though, or any other
feeling I can easily compare it to without sounding a little crazy. Imagine a
beam of television static blasting from a spot at the back, left side of your
head. The doctors didn&#x27;t say that other Vertigo patients had something similar.
But for me, it came with the Vertigo and left with the Vertigo.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;the-inner-ear&quot;&gt;The inner ear&lt;&#x2F;h2&gt;
&lt;p&gt;Let&#x27;s see what broke. &lt;a href=&quot;https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Hair_cell&quot;&gt;Hair cells&lt;&#x2F;a&gt; in
the cochlea that are excited by the fluid oscillations caused by sound waves,
letting us hear. The vestibular organs contain the same type of cell responding
to a different fluid movement - the movement of fluid rotating in the
semicircular canals in response to head rotation.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;&#x2F;images&#x2F;2019-12-20-britannica.jpg&quot; alt=&quot;Vestibular organs: https:&#x2F;&#x2F;www.britannica.com&#x2F;science&#x2F;utricle&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;The &lt;em&gt;semicircular canals&lt;&#x2F;em&gt; are
large enough to see in an MRI scan. If you&#x27;d like to see &lt;em&gt;my&lt;&#x2F;em&gt;
semi-circular canals, feast your eyes.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;&#x2F;images&#x2F;2019-12-20-canalsMRI.jpg&quot; alt=&quot;My MRI Brain scan, Mercy Neurology department&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;To detect static head orientation, we need to make use of gravity. In the inner
ear, we see these same cells again, now embedded in jelly and capped by heavy
calcium crystals called &lt;em&gt;otoconia&lt;&#x2F;em&gt;. As a head tilts one way or the other,
these crystals shift their position, activating sets of hair cells sensitive to
that particular tilt.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;trouble-in-inner-ear-paradise&quot;&gt;Trouble in inner-ear paradise&lt;&#x2F;h2&gt;
&lt;p&gt;There is no physical barrier between the otoconia crystals in their jelly, and
the fluid of the semicircular canals.&lt;&#x2F;p&gt;
&lt;p&gt;Like any open office plan, this setup has problems. The otoconia crystals
sometimes dislodge from their jelly and float into the semicircular canal. The
heavy crystals interfere with the motion of the fluid in the canals during head
rotation, producing out-of-whack rotation signals.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;one-weird-trick&quot;&gt;One weird trick...&lt;&#x2F;h2&gt;
&lt;p&gt;Here is an idea so crazy that it just might work. We know the shapes of the
semicircular canals, we know where otoconia are supposed to live, and we know
that otoconia fall under the influence of gravity. Maybe we could rotate the
head through a series of positions to guide the otoconia back to their jelly?&lt;&#x2F;p&gt;
&lt;p&gt;One of my complaints about science is that our elegant models tend to fall over
in the face of real world complexity. But in this case, the model does work, and
a large number of Vertigo cases can be cured exactly this way. That&#x27;s one of the
things I was most delighted by in this whole journey.&lt;&#x2F;p&gt;
&lt;p&gt;Loose crystals from one sensory organ tresspassing into the working end of
another sesnory organ is a simple model. What made my vertigo story so
delightful to me was the way the model works in practice, to suggest a cure that
requires no drugs or prolonged therapy. The treatment is called the Epley
Maneuver.&lt;&#x2F;p&gt;
&lt;p&gt;If (a) crystals can get into the semicircular canals, (b) this cause problems
when crystals move and interfere with fluid sensors and (c) the shapes of the
canals are well known, then perhaps by rotating the head a certain way we could
coax the crystals back through the canals and into the utricle where they
belong, a bit like the toy with a marble navigated through a maze on a balance
board you control with knobs?&lt;&#x2F;p&gt;
&lt;p&gt;&lt;img src=&quot;&#x2F;images&#x2F;2019-12-20-lucky-labrynth.jpg&quot; alt=&quot;Lucky Labrynth&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Well, for that subset of vertigo cases where loose crystals are the cause, it
does work. And one has to wonder, when Epley first tried it successfully, was
this a Eureka! moment for him, or with total confidence in the crystal
hypothesis did he shrug the maneuver&#x27;s success off as trivial.&lt;&#x2F;p&gt;
&lt;p&gt;When the right side (most commonly, the hindmost of the three canals) is the
problem, the crystals tend to settle at a low point in the ring, and we want to
get them around the top of the ring and back into the utricle. The maneuver goes like this:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Sit straight up&lt;&#x2F;li&gt;
&lt;li&gt;Turn the head 45 degrees to the right&lt;&#x2F;li&gt;
&lt;li&gt;Keeping the turn, lay back fairly quickly, letting the head hang below the sholders&lt;&#x2F;li&gt;
&lt;li&gt;After the nystagmus subsides, remain lying down and turn the head toward the opposite side&lt;&#x2F;li&gt;
&lt;li&gt;After the next wave of nystagmus subsides, roll onto your left side, keeping your
head turned toward your left shoulder&lt;&#x2F;li&gt;
&lt;li&gt;After the next wave of nystagmus subsides, lift your body to a sitting position&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;To see why this works, try the procedure on the model head below. The model
has two loose crystals in his right canal. The controls are tricky, but if you
get the sequence right, they will land on the green &quot;utricle&quot; and be stable
there as long as the head stays upright.&lt;&#x2F;p&gt;
&lt;iframe srcdoc=&quot;
&lt;html&gt;
&lt;body style=&#x27;margin:0px&#x27;&gt;
&lt;div id=&#x27;epley_container&#x27; onClick=&#x27;go()&#x27; style=&#x27;position:relative&#x27;&gt;
  &lt;p id=&#x27;click_to_start&#x27; style=&#x27;position:absolute&#x27;&gt;Click to start&lt;&#x2F;p&gt;
  &lt;img id=&#x27;instructions&#x27; src=&#x27;&#x2F;images&#x2F;2019-12-20-instructions.svg&#x27; style=&#x27;position:absolute&#x27;&#x2F;&gt;
&lt;&#x2F;div&gt;
&lt;script src=&#x27;&#x2F;js&#x2F;cannon.min.js&#x27;&gt;&lt;&#x2F;script&gt;
&lt;script src=&#x27;&#x2F;js&#x2F;three.min.js&#x27;&gt;&lt;&#x2F;script&gt;
&lt;script src=&#x27;&#x2F;js&#x2F;TrackballControls.js&#x27;&gt;&lt;&#x2F;script&gt;
&lt;script src=&#x27;&#x2F;js&#x2F;epley.js&#x27;&gt;&lt;&#x2F;script&gt;
&lt;&#x2F;body&gt;
&lt;&#x2F;html&gt;
&quot; width=&quot;600px&quot; height=&quot;410px&quot;&gt;&lt;&#x2F;iframe&gt;
&lt;p&gt;If the head can bec back to the upright position without the red crystals
falling back down, you win!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;feels&quot;&gt;Feels&lt;&#x2F;h2&gt;
&lt;p&gt;As you can see in the simulation, when the head is still, gravity brings the
crystals to their lowest location. A few minutes after lying down in bed, things
in the inner ear are settled down. The fluid motion sensors are not being
activated. Everything feels back to normal.&lt;&#x2F;p&gt;
&lt;p&gt;Being still in bed is so comfortable, in fact, that you can start to wonder if
the whole condition is clearing up and you can go back to normal activities
soon. But, for quite some time, sitting up very reliably brings back the vertigo
and all the discomfort. This ends up training you not to leave the bed, to spend
a long time after waking up in an anxious state, temporarily cured and hoping
that you will still be ok when you get up, but knowing that probably won&#x27;t
happen. It&#x27;s emotionally hard, and during this episode, I gained a ton of
sympathy for people with chronic illness.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;treatment&quot;&gt;Treatment&lt;&#x2F;h3&gt;
&lt;p&gt;Here is a rough breakdown of the medical care I received, with the cost after insurance.&lt;&#x2F;p&gt;
&lt;p&gt;Date        Center                  Cost&lt;&#x2F;p&gt;
&lt;hr &#x2F;&gt;
&lt;p&gt;2019-06-02  Urgent Care             $150
2019-06-02  Union Memorial Hospital $800
2019-06-20  Mercy Otolaryngology    $100
2019-07-20  Mercy Neurology         $150
2019-08-02  Mercy Radiology         $150
2019-12-03  Hopkins Otolaryngology  $100&lt;&#x2F;p&gt;
&lt;p&gt;The first two trips happened because the dizziness came on so strongly that my
wife and I thought there may be a serious issue. Urgent Care also didn&#x27;t want to
rule anything out, and they urged us to go to the ER (it was fairly late at
night, and I couldn&#x27;t reach my family physician).&lt;&#x2F;p&gt;
&lt;p&gt;I was perscribed nausea medicine and told that I probably had viral
labrynthitis, which should resolve itself it 3 to 14 days. While the strongest
phase did die down after a couple of weeks, I had the residual feelings
mentioned above. They could come and go, maybe once a month I had a week of
symptoms.&lt;&#x2F;p&gt;
&lt;p&gt;So I kept seeing other specialists. An otolaryngologist at Mercy Medical agreed
that it was viral labrynthitis and prescribed low-dose valium and waiting. We
decided not to take the valium - due to the wait times before our visits, the
visit tended to happen on the tail end of a bout of vertigo, and I was scared of
taking anything psychoactive when the symptoms were subsiding anyway.&lt;&#x2F;p&gt;
&lt;p&gt;The trip to Mercy Neurology was recommended because of the stranger symytoms I
mentioned above. The nails-on-the-board, the beam of corrupt information - these
things hinted that there may be something wrong with my noodle. But the battery
of tests didn&#x27;t turn up anything, and my MRI scans looked normal.&lt;&#x2F;p&gt;
&lt;p&gt;In summary, the treatment from June through August was kind and caring, but
didn&#x27;t make much progress in clearing up the symptoms.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;the-fix&quot;&gt;The Fix&lt;&#x2F;h3&gt;
&lt;p&gt;As it happens, my wife studied the neurons of the vestibular system&lt;sup class=&quot;footnote-reference&quot;&gt;&lt;a href=&quot;#xpl2016&quot;&gt;1&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;
and the hair cells of the utricle&lt;sup class=&quot;footnote-reference&quot;&gt;&lt;a href=&quot;#xpl2016b&quot;&gt;2&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt; in her doctoral and postdoc labs,
which were hospital-affiliated. She managed to use some of her connections to
get me an appointment at Johns Hopkins Otolaryngology. I&#x27;ll add that she did
this without much help from me - in a typical partners dynamic, I was resistent
to seeing more doctors after having had so little success in the past.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m grateful she did, though. Becuase the doctor I saw, Yuri Agrawal, finally
diagnosed the issue and solved it during the office visit with the Epley
maneuver.&lt;&#x2F;p&gt;
&lt;p&gt;I noticed the impact when I left the office and got into my car. I was between
episodes at the time - I thought that I felt mostly fine, not dizzy. In truth, I
had adapted to much of the vertigo. And after the treatment, all of the residual
symptoms that I had gotten used to disappeared. I felt like I could perfectly
focus on distant points. I could move my head around quickly and easily focus on
several objects a second (during a dizziness episode, I couldn&#x27;t drive; between
episodes, I drove rigidly, giving myself lots of extra time before making turns,
since it took longer for me to look around at all the surroundings). The general
sense of &quot;displacement&quot; was gone. It had been 5 months since I started feeling
bad, and now, I felt like I had super-powers. There was a lot of happy giggling
on my solo drive home from Hopkins Medical.&lt;&#x2F;p&gt;
&lt;p&gt;Thank you, Dr. Agrawal!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;disclaimer&quot;&gt;Disclaimer&lt;&#x2F;h2&gt;
&lt;p&gt;This blog post may sound like medical advice. I really want to emphasize - I&#x27;m not
a doctor. I have no idea how common BPPV is compared to other causes of vertigo,
so I have no idea how likely the Epley maneuver is to work for you if you&#x27;re
having vertigo. Talk to a doctor.&lt;&#x2F;p&gt;
&lt;p&gt;During my visit with Dr. Agrawal, which had the fast pacing of a doctor who
leads a dual life as head of a research lab, she explained some of the inner ear
biology that kicked off my exploration, and recommended I look up Richard
Rabbitt, who has done really interesting physical simulation&lt;sup class=&quot;footnote-reference&quot;&gt;&lt;a href=&quot;#rabbitt&quot;&gt;3&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt; of the Epley
maneuver.&lt;&#x2F;p&gt;
&lt;p&gt;There are a lot of inaccuracies in my simulation. To get a much better (though
not interactive) view of how and why the Epley Maneuver works. You can also meet
Dr. John Epley himself!&lt;sup class=&quot;footnote-reference&quot;&gt;&lt;a href=&quot;#epley_youtube&quot;&gt;4&lt;&#x2F;a&gt;&lt;&#x2F;sup&gt;&lt;&#x2F;p&gt;
&lt;p&gt;I wanted to share my story, and to try out some ideas that had gotten into my
head (the vertigo simulator and the interactive Epley model above), in the
context of this unpleasant episode in my life.&lt;&#x2F;p&gt;
&lt;p&gt;One takeaway - there can be light at the end of the tunnel, and sometimes
although a partner&#x27;s involvement in your medical choices can feel a little
overbearing, they may often be right. As I tearfully told her after my
treatment, since I&#x27;m naturally reluctant to see doctors, if she hadn&#x27;t been so
persistent then I might have gone the rest of my life with on-and-off BPPV.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;one-year-later&quot;&gt;One Year Later&lt;&#x2F;h2&gt;
&lt;p&gt;Since I wrote this posts, a year passed. I&#x27;m sad to say that the Epley
maneuver wasn&#x27;t the end of my Vertigo story. I had 3 more bouts of Vertigo,
spaced about two months apart, and leasting for 1 or 2 weeks. Strangely,
each episode was followed by strong hearing loss in my left ear. Further
trips to Hopkins Otolaryngology lead to no clear diagnosis. My symptoms
resemble either Menier&#x27;s Disease, BPPV, or vestibular migraine at different
times.&lt;&#x2F;p&gt;
&lt;p&gt;To try to get a diagnosis, I&#x27;ve been tracking my food, stress and sleep.
It seems like sleep deprivation, alcohol or alcohol consumption may be a
triggers. I would like to narrow it down, but I recently started a new job
and I&#x27;m reluctant to do the right experiments to bring on vertigo episodes
that interfere with my work and my ability to drive my family around.&lt;&#x2F;p&gt;
&lt;p&gt;On the bright side, now that I&#x27;m avoiding all the possible triggers that I&#x27;m
aware of, it&#x27;s been 6 months since I&#x27;ve had an episode.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;footnotes&quot;&gt;Footnotes&lt;&#x2F;h2&gt;
&lt;div class=&quot;footnote-definition&quot; id=&quot;xpl2016&quot;&gt;&lt;sup class=&quot;footnote-definition-label&quot;&gt;1&lt;&#x2F;sup&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;www.ncbi.nlm.nih.gov&#x2F;pubmed&#x2F;26936982&quot;&gt;Sodium channel diversity in the vestibular ganglion: NaV1.5,
NaV1.8, and tetrodotoxin-sensitive
currents&lt;&#x2F;a&gt; on PubMed&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;div class=&quot;footnote-definition&quot; id=&quot;xpl2016b&quot;&gt;&lt;sup class=&quot;footnote-definition-label&quot;&gt;2&lt;&#x2F;sup&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;www.ncbi.nlm.nih.gov&#x2F;pubmed&#x2F;?term=liu+holt+utricle&quot;&gt;Functional development of mechanosensitive hair cells in stem
cell-derived organoids parallels native vestibular hair
cells&lt;&#x2F;a&gt; on PubMed&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;div class=&quot;footnote-definition&quot; id=&quot;rabbitt&quot;&gt;&lt;sup class=&quot;footnote-definition-label&quot;&gt;3&lt;&#x2F;sup&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;www.ncbi.nlm.nih.gov&#x2F;pubmed&#x2F;28877495&quot;&gt;Wave mechanics of the vestibular semicircular
canals&lt;&#x2F;a&gt; on PubMed&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
&lt;div class=&quot;footnote-definition&quot; id=&quot;epley_youtube&quot;&gt;&lt;sup class=&quot;footnote-definition-label&quot;&gt;4&lt;&#x2F;sup&gt;
&lt;p&gt;An educational VHS video destribing BPPV and the Epley Maneuver.
John Epley gives part of the introduction. &lt;a href=&quot;https:&#x2F;&#x2F;www.ncbi.nlm.nih.gov&#x2F;pubmed&#x2F;28877495&quot;&gt;https:&#x2F;&#x2F;www.ncbi.nlm.nih.gov&#x2F;pubmed&#x2F;28877495&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;&#x2F;div&gt;
</description>
      </item>
      <item>
          <title>Typechecking code in a Hakyll blog</title>
          <pubDate>Sun, 20 Oct 2019 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://blog.greghale.io/posts/typechecking-posts/</link>
          <guid>https://blog.greghale.io/posts/typechecking-posts/</guid>
          <description xml:base="https://blog.greghale.io/posts/typechecking-posts/">&lt;h1 id=&quot;typechecking-code-in-a-hakyll-blog&quot;&gt;Typechecking code in a Hakyll blog&lt;&#x2F;h1&gt;
&lt;p&gt;After years of programming in Haskell, my natural ability to
scrutinize my code for type errors (and even more mundane things,
like parse errors and spelling errors) has atrophied. Usually
my friends &lt;code&gt;ghc&lt;&#x2F;code&gt; and &lt;code&gt;ghcid&lt;&#x2F;code&gt; take care of this for me so I can
think about other things.&lt;&#x2F;p&gt;
&lt;p&gt;Recovering this workflow when writing &lt;em&gt;blog posts&lt;&#x2F;em&gt; took a little
time.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;literate-haskell&quot;&gt;Literate Haskell&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;code&gt;Hakyll&lt;&#x2F;code&gt; handles Literate Haskell files already - you don&#x27;t have
to do any work. Just create a file in &lt;code&gt;posts&#x2F;&lt;&#x2F;code&gt; with the &lt;code&gt;.lhs&lt;&#x2F;code&gt;
file extension.&lt;&#x2F;p&gt;
&lt;p&gt;The format is described well in the
&lt;a href=&quot;https:&#x2F;&#x2F;wiki.haskell.org&#x2F;Literate_programming&quot;&gt;Haskell Wiki&lt;&#x2F;a&gt;.
The only features I&#x27;ve used so far are&lt;&#x2F;p&gt;
&lt;h3 id=&quot;code-blocks&quot;&gt;Code blocks&lt;&#x2F;h3&gt;
&lt;p&gt;Most of my code blocks are long, so I prefer the latex-like
command over bird-tracks&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;latex&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-latex &quot;&gt;&lt;code class=&quot;language-latex&quot; data-lang=&quot;latex&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;\begin&lt;&#x2F;span&gt;&lt;span&gt;{code}
&lt;&#x2F;span&gt;&lt;span&gt;example = do
&lt;&#x2F;span&gt;&lt;span&gt;  x &amp;lt;- getTheX
&lt;&#x2F;span&gt;&lt;span&gt;  useX x
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;\end&lt;&#x2F;span&gt;&lt;span&gt;{code}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;hidden-imports&quot;&gt;Hidden imports&lt;&#x2F;h3&gt;
&lt;p&gt;Of course we need to import some modules if &lt;code&gt;ghc&lt;&#x2F;code&gt; is to
typecheck our &lt;code&gt;.lhs&lt;&#x2F;code&gt; file. Since the imports are often not
important to the explanation in the blog, I hide them.&lt;&#x2F;p&gt;
&lt;p&gt;Imaginary functions that I will later use in the blog post
but which aren&#x27;t important to the topic at hand can be defined
here, too.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;latex&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-latex &quot;&gt;&lt;code class=&quot;language-latex&quot; data-lang=&quot;latex&quot;&gt;&lt;span style=&quot;color:#96b5b4;&quot;&gt;\long&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;\def&lt;&#x2F;span&gt;&lt;span style=&quot;color:#96b5b4;&quot;&gt;\ignore&lt;&#x2F;span&gt;&lt;span&gt;#1{}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#96b5b4;&quot;&gt;\ignore&lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;\begin&lt;&#x2F;span&gt;&lt;span&gt;{code}
&lt;&#x2F;span&gt;&lt;span&gt;{-# LANGUAGE ScopedTypeVariables, OverloadedStrings, TypeApplications #-}
&lt;&#x2F;span&gt;&lt;span&gt;import qualified Servant.Server as Servant
&lt;&#x2F;span&gt;&lt;span&gt;import Servant.API ((:&amp;lt;|&amp;gt;), (:&amp;gt;))
&lt;&#x2F;span&gt;&lt;span&gt;import qualified Database.PostgreSQL.Simple as PG
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;processInputs :: Inputs -&amp;gt; IO Outputs
&lt;&#x2F;span&gt;&lt;span&gt;processInputs = undefined
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;\end&lt;&#x2F;span&gt;&lt;span&gt;{code}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;nix-shell&quot;&gt;nix-shell&lt;&#x2F;h2&gt;
&lt;p&gt;A separate &lt;code&gt;nix-shell&lt;&#x2F;code&gt; is available for every post, in &lt;code&gt;shells.nix&lt;&#x2F;code&gt;.
At the top of this file is a record that maps post names to the names
of &lt;code&gt;Haskell&lt;&#x2F;code&gt; packages that I need to have in scope. There&#x27;s only one
entry at the time of writing, because I only have one Literate Haskell
blog post:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;nix&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-nix &quot;&gt;&lt;code class=&quot;language-nix&quot; data-lang=&quot;nix&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;let
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;shellPkgs &lt;&#x2F;span&gt;&lt;span&gt;=
&lt;&#x2F;span&gt;&lt;span&gt;    { &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;config-phases &lt;&#x2F;span&gt;&lt;span&gt;= [&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;generic-lens&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;lens&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;postgresql-simple&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot; &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;katip&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;]; };
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Later in the file, these lists are turned into derivations, so that I
can say&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;nix-shell&lt;&#x2F;span&gt;&lt;span&gt; .&#x2F;shells.nix&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt; -A&lt;&#x2F;span&gt;&lt;span&gt; config-phases \
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;  --run &lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;ghcid --command &amp;quot;ghci posts&#x2F;2019-10-17-config-phase.lhs&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;&amp;#39;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;and now &lt;code&gt;ghcid&lt;&#x2F;code&gt; is recompiling my post and showing me the type errors
every time the post is saved.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Organizing configs by usage phase</title>
          <pubDate>Thu, 17 Oct 2019 00:00:00 +0000</pubDate>
          <author>Unknown</author>
          <link>https://blog.greghale.io/posts/config-phase/</link>
          <guid>https://blog.greghale.io/posts/config-phase/</guid>
          <description xml:base="https://blog.greghale.io/posts/config-phase/">&lt;h1 id=&quot;organizing-configs-by-usage-phase&quot;&gt;Organizing configs by usage phase&lt;&#x2F;h1&gt;
&lt;h2 id=&quot;configuration-sprawl&quot;&gt;Configuration sprawl&lt;&#x2F;h2&gt;
&lt;p&gt;Have you found your configuration handling begins to sprawl as you add more
configuration to your program? This example makes two database connections
and allows the hostname and logging level to be configured. Imagine how
&lt;code&gt;main&lt;&#x2F;code&gt; might grow over time as different people follow the patterns they
find here while adding more parameters.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;haskell&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-haskell &quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;&lt;span&gt;{-# &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;LANGUAGE&lt;&#x2F;span&gt;&lt;span&gt; RecordWildCards, DeriveGeneric, DuplicateRecordFields, KindSignatures #-}
&lt;&#x2F;span&gt;&lt;span&gt;{-# &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;LANGUAGE&lt;&#x2F;span&gt;&lt;span&gt; MultiParamTypeClasses, DataKinds, TypeFamilies, FunctionalDependencies #-}
&lt;&#x2F;span&gt;&lt;span&gt;{-# &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;LANGUAGE&lt;&#x2F;span&gt;&lt;span&gt; AllowAmbiguousTypes, TypeApplications, FlexibleContexts, FlexibleInstances #-}
&lt;&#x2F;span&gt;&lt;span&gt;{-# &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;LANGUAGE&lt;&#x2F;span&gt;&lt;span&gt; ScopedTypeVariables, DefaultSignatures #-}
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;import           &lt;&#x2F;span&gt;&lt;span&gt;Data.Text                         (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;Text&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;import           &lt;&#x2F;span&gt;&lt;span&gt;GHC.Generics                      (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;Generic&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;import           &lt;&#x2F;span&gt;&lt;span&gt;Control.Lens
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;import qualified &lt;&#x2F;span&gt;&lt;span&gt;Data.Text                         &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;as &lt;&#x2F;span&gt;&lt;span&gt;Text
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;import qualified &lt;&#x2F;span&gt;&lt;span&gt;Katip
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;import qualified &lt;&#x2F;span&gt;&lt;span&gt;Database.PostgreSQL.Simple        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;as &lt;&#x2F;span&gt;&lt;span&gt;PG
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;import qualified &lt;&#x2F;span&gt;&lt;span&gt;Data.Generics.Product.Constraints &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;as &lt;&#x2F;span&gt;&lt;span&gt;GenericLens
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;data &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;ConfigExample1 &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;ConfigExample1
&lt;&#x2F;span&gt;&lt;span&gt;  { hostname   :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Text
&lt;&#x2F;span&gt;&lt;span&gt;  , userDBUser :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;String
&lt;&#x2F;span&gt;&lt;span&gt;  , userDBPass :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;String
&lt;&#x2F;span&gt;&lt;span&gt;  , userDBDB   :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;String
&lt;&#x2F;span&gt;&lt;span&gt;  , userDBPort :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Integer
&lt;&#x2F;span&gt;&lt;span&gt;  , userDBHost :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;String
&lt;&#x2F;span&gt;&lt;span&gt;  , logLevel :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Katip&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Severity
&lt;&#x2F;span&gt;&lt;span&gt;  , analysisDBUser :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;String
&lt;&#x2F;span&gt;&lt;span&gt;  , analysisDBHost :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;String
&lt;&#x2F;span&gt;&lt;span&gt;  , analysisDBPort :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Integer
&lt;&#x2F;span&gt;&lt;span&gt;  , analysisDBDB   :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;String
&lt;&#x2F;span&gt;&lt;span&gt;  , analysisDBPass :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;String
&lt;&#x2F;span&gt;&lt;span&gt;  } &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;deriving&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;Generic&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;main &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;:: IO &lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;main = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;do
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;ConfigExample1&lt;&#x2F;span&gt;&lt;span&gt;{..} &amp;lt;- loadConfig &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;local.yaml&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;  print &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;Connecting to User Database&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;  userDB &amp;lt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.connect &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;ConnectInfo
&lt;&#x2F;span&gt;&lt;span&gt;      { &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.connectUser     = userDBUser
&lt;&#x2F;span&gt;&lt;span&gt;      , &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.connectHost     = userDBHost
&lt;&#x2F;span&gt;&lt;span&gt;      , &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.connectPort     = fromIntegral userDBPort
&lt;&#x2F;span&gt;&lt;span&gt;      , &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.connectPassword = userDBPass
&lt;&#x2F;span&gt;&lt;span&gt;      , &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.connectDatabase = userDBDB
&lt;&#x2F;span&gt;&lt;span&gt;      }
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;-- ... a block of initialization code
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;-- ... maybe written by other team members
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;--
&lt;&#x2F;span&gt;&lt;span&gt;  analysisDB &amp;lt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.connect &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;ConnectInfo
&lt;&#x2F;span&gt;&lt;span&gt;      { &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.connectUser     = analysisDBUser
&lt;&#x2F;span&gt;&lt;span&gt;      , &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.connectHost     = analysisDBHost
&lt;&#x2F;span&gt;&lt;span&gt;      , &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.connectPort     = fromIntegral analysisDBPort
&lt;&#x2F;span&gt;&lt;span&gt;      , &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.connectPassword = analysisDBPass
&lt;&#x2F;span&gt;&lt;span&gt;      , &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.connectDatabase = analysisDBDB
&lt;&#x2F;span&gt;&lt;span&gt;      }  
&lt;&#x2F;span&gt;&lt;span&gt;  runBusinessLogic analysisDB userDB logLevel (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Text&lt;&#x2F;span&gt;&lt;span&gt;.unpack hostname)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;runBusinessLogic
&lt;&#x2F;span&gt;&lt;span&gt;  :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Connection
&lt;&#x2F;span&gt;&lt;span&gt;  -&amp;gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Connection
&lt;&#x2F;span&gt;&lt;span&gt;  -&amp;gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Katip&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Severity
&lt;&#x2F;span&gt;&lt;span&gt;  -&amp;gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;String
&lt;&#x2F;span&gt;&lt;span&gt;  -&amp;gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;IO ()
&lt;&#x2F;span&gt;&lt;span&gt;runBusinessLogic userDB analysisDB logLevel myHostname = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;do
&lt;&#x2F;span&gt;&lt;span&gt;  undefined
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;What problems will we run into as we try to scale this program up?&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Flat format&lt;&#x2F;strong&gt; Without organization, it&#x27;s easy for config files
and their parsers to become confusing&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Unchecked Redundancy&lt;&#x2F;strong&gt; The fields of &lt;code&gt;ConfigExample1&lt;&#x2F;code&gt; correspond to
the arguments of &lt;code&gt;runBusinessLogic&lt;&#x2F;code&gt;, but the correspondence is
loose (we have a collection of &lt;code&gt;Text&lt;&#x2F;code&gt; and &lt;code&gt;Int&lt;&#x2F;code&gt; fields in the config
but a &lt;code&gt;PG.Connection&lt;&#x2F;code&gt; in the arguments.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Ad-hoc resource acquisition&lt;&#x2F;strong&gt; The code used for reading config fields
and creating resources from them can get messy quickly&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;organizing-configuration&quot;&gt;Organizing configuration&lt;&#x2F;h2&gt;
&lt;p&gt;We can address these problems and add a lot of structure to our
configuration. Let&#x27;s start by drawing a connection between
the configuration phase, and the running phase. We&#x27;ll start by
using a single configuration type that abstracts over the &lt;em&gt;phase&lt;&#x2F;em&gt;
at which it is used:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;haskell&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-haskell &quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;data &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;ConfigF&lt;&#x2F;span&gt;&lt;span&gt; (p :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Phase&lt;&#x2F;span&gt;&lt;span&gt;) = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Config
&lt;&#x2F;span&gt;&lt;span&gt;  { userDB     :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;AtPhase&lt;&#x2F;span&gt;&lt;span&gt; p &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Connection
&lt;&#x2F;span&gt;&lt;span&gt;  , analysisDB :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;AtPhase&lt;&#x2F;span&gt;&lt;span&gt; p &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Connection
&lt;&#x2F;span&gt;&lt;span&gt;  , hostname   :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Text
&lt;&#x2F;span&gt;&lt;span&gt;  , logLevel   :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Katip&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Severity
&lt;&#x2F;span&gt;&lt;span&gt;  } &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;deriving&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;Generic&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Config    &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;ConfigF&lt;&#x2F;span&gt;&lt;span&gt; &amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;ConfigTime
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Resources &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;ConfigF&lt;&#x2F;span&gt;&lt;span&gt; &amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;RunTime
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Some of our configuration fields are regular Haskell datatypes, like
&lt;code&gt;Text&lt;&#x2F;code&gt; and &lt;code&gt;Katip.Severity&lt;&#x2F;code&gt;. These values are specified and used in
the same way. But the &lt;code&gt;userDB&lt;&#x2F;code&gt; and &lt;code&gt;analysisDB&lt;&#x2F;code&gt; fields are defined
in terms of &lt;code&gt;Phase&lt;&#x2F;code&gt; and &lt;code&gt;AtPhase&lt;&#x2F;code&gt;, which we are about to define.&lt;&#x2F;p&gt;
&lt;p&gt;Accepting some complexity here allows us to share a single type definition
for specifying two things (a) the configuration &lt;em&gt;data&lt;&#x2F;em&gt; and (b) the
configuration &lt;em&gt;result&lt;&#x2F;em&gt;, in one go.&lt;&#x2F;p&gt;
&lt;p&gt;Our &lt;code&gt;main&lt;&#x2F;code&gt; function will look more like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;haskell&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-haskell &quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;&lt;span&gt;main&amp;#39; = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;do
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;cfg &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;:: Config&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;loadConfig&lt;&#x2F;span&gt;&lt;span&gt; &amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;local&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;yaml&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;res &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;:: Resources&lt;&#x2F;span&gt;&lt;span&gt; &amp;lt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;buildConfig cfg
&lt;&#x2F;span&gt;&lt;span&gt;  runBusinessLogic&amp;#39; res
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;runBusinessLogic&amp;#39; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;:: Resources -&amp;gt; IO &lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;runBusinessLogic&amp;#39; = undefined
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Whether the added complexity is worth it depends on a few things.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Configuration complexity&lt;&#x2F;strong&gt; If your configuration is simple,
then you don&#x27;t benefit from deduplicating the configuration
and runtime types&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Complexity budget&lt;&#x2F;strong&gt; We&#x27;ll be adding a typeclass and
a type family. If there are other aspects of your codebase
that use your complexity budget, or if the budget is low
for other reasons, then it&#x27;s best to treat this technique
as a fun curiosity. Use your budget on something with a
higher power-to-weight ratio, like &lt;a href=&quot;https:&#x2F;&#x2F;dhall-lang.org&quot;&gt;dhall&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Let&#x27;s build the required machinery.&lt;&#x2F;p&gt;
&lt;p&gt;First, we use &lt;code&gt;DataKinds&lt;&#x2F;code&gt; to
define a new kind &lt;code&gt;Phase&lt;&#x2F;code&gt;
inhabited by two types &lt;code&gt;&#x27;ConfigTime&lt;&#x2F;code&gt; and &lt;code&gt;&#x27;RunTime&lt;&#x2F;code&gt;
to specialize our application&#x27;s configuration for one phase or the other.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;haskell&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-haskell &quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;data &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Phase
&lt;&#x2F;span&gt;&lt;span&gt;  = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;ConfigTime
&lt;&#x2F;span&gt;&lt;span&gt;  | &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;RunTime
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Next, a type family will let us associate a configuration type
to a runtime type for some particular resource.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;haskell&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-haskell &quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;HasPhases &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;t &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;where
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;AtPhase&lt;&#x2F;span&gt;&lt;span&gt; (p :: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Phase&lt;&#x2F;span&gt;&lt;span&gt;) t
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;instance HasPhases PG&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;Connection where
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;AtPhase&lt;&#x2F;span&gt;&lt;span&gt; &amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;ConfigTime PG&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Connection &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;ConnectInfo
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;type &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;AtPhase&lt;&#x2F;span&gt;&lt;span&gt; &amp;#39;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;RunTime    PG&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Connection &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;Connection
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Another typeclass allows the construction of a resource
from its configuration data. The two type parameters correspond
to the configtime and runtime types.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;haskell&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-haskell &quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;class &lt;&#x2F;span&gt;&lt;span style=&quot;color:#a3be8c;&quot;&gt;ToRuntime &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;cty rty &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;where
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;toRuntime &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;:: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;cty &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;-&amp;gt; IO &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;rty
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#65737e;&quot;&gt;-- | Catch-all instance for regular (not phase-specific) types
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;instance ToRuntime &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bf616a;&quot;&gt;ty ty &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;where
&lt;&#x2F;span&gt;&lt;span&gt;  toRuntime = return
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;instance ToRuntime PG&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;ConnectInfo PG&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;Connection where
&lt;&#x2F;span&gt;&lt;span&gt;  toRuntime = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;PG&lt;&#x2F;span&gt;&lt;span&gt;.connect
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;There is a catch-all instance for cases when the configtime
type is the same as the runtime type. When we eventually
process our configuration record, the catch-all instance will
apply to any field with a regular type, like our
&lt;code&gt;hostname&lt;&#x2F;code&gt; field. (It would also match any
&lt;code&gt;AtPhase&lt;&#x2F;code&gt; fields where configtime type is equal
to the runtime type.. but if we ever use &lt;code&gt;AtPhase&lt;&#x2F;code&gt;,
we would do that &lt;em&gt;in order to&lt;&#x2F;em&gt; let the types differ
across phases, so we won&#x27;t encounter this case. Sorry for
the aside, I hope it makes sense)&lt;&#x2F;p&gt;
&lt;h2 id=&quot;generic-lens&quot;&gt;generic-lens&lt;&#x2F;h2&gt;
&lt;p&gt;In order to have our &lt;code&gt;buildConfig&lt;&#x2F;code&gt; function, we
will use some fabulous magic from
&lt;a href=&quot;http:&#x2F;&#x2F;hackage.haskell.org&#x2F;package&#x2F;generic-lens&quot;&gt;generic-lens&lt;&#x2F;a&gt;.
Specifically, &lt;a href=&quot;http:&#x2F;&#x2F;hackage.haskell.org&#x2F;package&#x2F;generic-lens-1.2.0.1&#x2F;docs&#x2F;Data-Generics-Product-Constraints.html#v:constraints&quot;&gt;&lt;code&gt;constraints&lt;&#x2F;code&gt;&lt;&#x2F;a&gt;
allows us to traverse a record, applying an effectful function
at every field with a type satisfying some particular constraint.&lt;&#x2F;p&gt;
&lt;p&gt;We choose that constraint to be our &lt;code&gt;ToRuntime&lt;&#x2F;code&gt; class.&lt;&#x2F;p&gt;
&lt;p&gt;Now we can write &lt;code&gt;buildConfig&lt;&#x2F;code&gt; without repeating any
details about the internals of our configuration record.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;haskell&quot; style=&quot;background-color:#2b303b;color:#c0c5ce;&quot; class=&quot;language-haskell &quot;&gt;&lt;code class=&quot;language-haskell&quot; data-lang=&quot;haskell&quot;&gt;&lt;span style=&quot;color:#8fa1b3;&quot;&gt;buildConfig &lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;:: ConfigF ConfigTime -&amp;gt; IO&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#b48ead;&quot;&gt;ConfigF RunTime&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;buildConfig = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;GenericLens&lt;&#x2F;span&gt;&lt;span&gt;.constraints @&lt;&#x2F;span&gt;&lt;span style=&quot;color:#d08770;&quot;&gt;ToRuntime&lt;&#x2F;span&gt;&lt;span&gt; toRuntime
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;summing-up&quot;&gt;Summing up&lt;&#x2F;h2&gt;
&lt;p&gt;Summing up, we have removed a few types of duplication and
informality from the process of building runtime resources
from configuration data.&lt;&#x2F;p&gt;
&lt;p&gt;We parameterized a single configuration record by the
phase, either configuration time or runtime.&lt;&#x2F;p&gt;
&lt;p&gt;And we concentrated the work of instantiating a runtime
resource record from the configuration record into a very generic
function.&lt;&#x2F;p&gt;
&lt;p&gt;Was it worth it? In effect, we sacrificed &lt;code&gt;Haskell98&lt;&#x2F;code&gt;&#x27;s
simplicity at the altar of the DRY (Don&#x27;t Repeat Yourself)
principle. Repetition is legitimately dangerous, especially
in a codebase with multiple authors, written in a language
where type safety encourages us to skimp on testing. The
competing interests here (redundancy vs. complexity) depend
on just how much redundancy you are cleaning up.&lt;&#x2F;p&gt;
&lt;p&gt;Thanks to Sarah Brofeldt (&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;srhb&quot;&gt;@srhb&lt;&#x2F;a&gt;),
who fleshed out the idea with me and did much of the implementation.
Simple as it may look, we had to explore quite a few paths before
we found this solution.&lt;&#x2F;p&gt;
&lt;p&gt;Thanks also to K.A. Buhr for his very helpful
&lt;a href=&quot;https:&#x2F;&#x2F;stackoverflow.com&#x2F;questions&#x2F;51388962&#x2F;how-to-derive-generic-traversals-that-involve-a-type-family&#x2F;51409436#51409436&quot;&gt;answer&lt;&#x2F;a&gt; on StackOverflow.
&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;rossabaker&quot;&gt;Ross Baker&lt;&#x2F;a&gt;
read a draft of this post and gave great suggestions
for improvement - Thanks!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;related-work&quot;&gt;Related work&lt;&#x2F;h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;www.microsoft.com&#x2F;en-us&#x2F;research&#x2F;uploads&#x2F;prod&#x2F;2016&#x2F;11&#x2F;trees-that-grow.pdf&quot;&gt;Trees that Grow&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;reasonablypolymorphic.com&#x2F;blog&#x2F;higher-kinded-data&#x2F;&quot;&gt;Higher-Kinded Data&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
</description>
      </item>
    </channel>
</rss>
